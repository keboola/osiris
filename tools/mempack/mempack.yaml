# Output file (you will upload this single file to ChatGPT)
output: ./mempack.txt

notes: |
  Osiris – active milestone M2b (feature/mcp-server-opus).
  Prioritize MCP server stabilization (Phase 3) + verification.
  Pack deterministic, review-friendly sources. No secrets / no heavy logs / no runtime artifacts.

include:
# Core src
- osiris.py
- pyproject.toml
- requirements.txt
- setup.py
- osiris/cli/**/*.py
- osiris/mcp/**/*.py
- osiris/core/**/*.py
- osiris/components/*.py
- osiris/drivers/graphql_extractor_driver.py

# Components registry/specs
- components/spec.schema.json
- components/*/**/spec.yaml
- components/graphql.extractor/spec.yaml

# Docs – ADRs, milestones, reports, roadmap
- docs/adr/*.md
- docs/milestones/*.md
- docs/reports/**/*.md
- docs/mcp/**/*.md
- docs/security/**/*.md
- docs/testing/**/*.md
- docs/deployment/**/*.md
- docs/migration/**/*.md
- docs/CLAUDE.md
- docs/README.md

# CI & tools
- .github/workflows/*.yml
- .github/scripts/verify_redaction.py
- tools/mempack/**
- tools/validation/*.py
- tools/validation/README.md

# Tests (core + integration + perf)
- tests/mcp/**/*.py
- tests/integration/**/*.py
- tests/performance/**/*.py
- tests/security/**/*.py
- tests/load/**/*.py
- tests/core/**/*.py

# Repo meta
- CHANGELOG.md
- LICENSE
- SECURITY.md
- Makefile
- README.md
- pytest.ini

exclude:
# Large or transient
- "**/__pycache__/**"
- "**/*.pyc"
- "**/*.log"
- "**/*.ndjson*"
- "**/*.jsonl"
- "artifacts/**"
- "logs/**"
- "output/**"
- "testing_env/logs/**"
- "testing_env/dist/**"
- "osiris/tmp/**"
- "docs/archive/**"
- ".venv/**"
- ".vscode/**"
- ".pytest_cache/**"
- ".git/**"
- "osiris_pipeline.egg-info/**"

embed_tree: true
use_gitignore: true
max_bytes: 6000000 # ~6 MB limit

# ----------------------------------------------------------
# Commands: run before packing and include their stdout files
# ----------------------------------------------------------
commands:
# MCP components list
- output_path: tools/mempack/gen/mcp-components-list.json
  run: |
    source .venv/bin/activate
    cd testing_env
    python ../osiris.py mcp components list --json
  with_cmd: true
  shell: bash
  timeout: 30s
  on_error: fail

# MCP discovery sample
- output_path: tools/mempack/gen/mcp-discovery-sample.json
  run: |
    source .venv/bin/activate
    cd testing_env
    python ../osiris.py mcp discovery run --connection-id @mysql.db_movies --json
  with_cmd: true
  shell: bash
  timeout: 60s
  on_error: keep

# MCP memory capture (consent)
- output_path: tools/mempack/gen/mcp-memory-sample.json
  run: |
    source .venv/bin/activate
    cd testing_env
    python ../osiris.py mcp memory capture --session-id demo --text "Note for mempack" --consent --json
  with_cmd: true
  shell: bash
  timeout: 30s
  on_error: keep

# MCP AIOP list
- output_path: tools/mempack/gen/mcp-aiop-list.json
  run: |
    source .venv/bin/activate
    cd testing_env
    python ../osiris.py mcp aiop list --json
  with_cmd: true
  shell: bash
  timeout: 45s
  on_error: keep

# MCP AIOP show (first run id)
- output_path: tools/mempack/gen/mcp-aiop-show.json
  run: |
    source .venv/bin/activate
    cd testing_env
    rid=$(python ../osiris.py mcp aiop list --json | jq -r '.[0].run_id // empty' 2>/dev/null || echo "")
    if [ -n "$rid" ]; then
      python ../osiris.py mcp aiop show --run "$rid" --json
    fi
  with_cmd: true
  shell: bash
  timeout: 45s
  on_error: keep

# MCP selftest
- output_path: tools/mempack/gen/mcp-selftest.txt
  run: |
    source .venv/bin/activate
    cd testing_env
    time python ../osiris.py mcp run --selftest
  with_cmd: true
  shell: bash
  timeout: 60s
  on_error: keep

# Protocol & version sanity
- output_path: tools/mempack/gen/mcp-version.json
  run: |
    source .venv/bin/activate
    python - <<'PYCODE'
    from osiris.mcp import config
    import json
    print(json.dumps({
      "PROTOCOL_VERSION": getattr(config, "PROTOCOL_VERSION", None),
      "SERVER_VERSION": getattr(config, "SERVER_VERSION", None)
    }))
    PYCODE
  with_cmd: true
  shell: bash
  timeout: 10s
  on_error: keep

# Policy guard: oversized payload test
- output_path: tools/mempack/gen/mcp-policy-oversize.json
  run: |
    source .venv/bin/activate
    cd testing_env
    python - <<'PYCODE'
    import json, subprocess
    big = {"data": "x" * (17 * 1024 * 1024)}  # 17MB payload
    p = subprocess.run(
        ["python", "../osiris.py", "mcp", "connections", "list", "--json"],
        input=json.dumps(big).encode(),
        stdout=subprocess.PIPE, stderr=subprocess.PIPE
    )
    print(p.stdout.decode() or p.stderr.decode())
    PYCODE
  with_cmd: true
  shell: bash
  timeout: 60s
  on_error: keep

# Quick test run summary
- output_path: tools/mempack/gen/tests-summary.txt
  run: |
    source .venv/bin/activate
    pytest -q --maxfail=1 --disable-warnings > ../tools/mempack/gen/tests-summary.txt || true
  with_cmd: true
  shell: bash
  timeout: 180s
  on_error: keep

# MCP performance smoke
- output_path: tools/mempack/gen/tests-perf-smoke.txt
  run: |
    source .venv/bin/activate
    pytest tests/performance/test_mcp_overhead.py -q -k baseline > ../tools/mempack/gen/tests-perf-smoke.txt || true
  with_cmd: true
  shell: bash
  timeout: 120s
  on_error: keep

# MCP markers inventory
- output_path: tools/mempack/gen/pytest-markers.txt
  run: |
    source .venv/bin/activate
    pytest --markers > ../tools/mempack/gen/pytest-markers.txt || true
  with_cmd: true
  shell: bash
  timeout: 15s
  on_error: keep

# Project tree snapshot
- output_path: tools/mempack/gen/tree.txt
  run: |
    tree -L 3 -a > tools/mempack/gen/tree.txt
  with_cmd: false
  shell: bash
  timeout: 10s
  on_error: keep
