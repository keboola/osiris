# ADR 0014: OML v0.1.0 — Intent Schema & Guardrails

## Status
Accepted

## Context
OML (Osiris **Markup** Language) is the human‑authored, declarative **intent** format that describes *what* a pipeline should do. In M1c we introduce a minimal yet future‑proof OML v0.1.0 so that a deterministic compiler can transform intent into exact, runnable artifacts (manifest + per‑step configs). The schema must:
- be small and predictable,
- forbid secrets,
- support basic dependencies and simple flow control,
- allow external parameters and profiles,
- remain extensible without breaking determinism.

This ADR defines the v0.1.0 surface and guardrails the compiler and validation rely on.

## Decision

### Top‑level document
- `oml_version` (string, semver) — e.g. `"0.1.0"`.
- `name` (string) — human label.
- `description` (string, optional).
- `params` (map&lt;string, ParamDecl&gt;, optional) — declarative *inputs* to bind at compile/run time.
- `profiles` (map&lt;name, Profile&gt;, optional) — environment overrides for **non‑secret** values (e.g. `dev|staging|prod`).
- `steps` (array&lt;Step&gt;) — ordered **declaration** of steps (the compiler still computes the DAG via `needs` etc.).
- `run` (optional) — run metadata: `run_id` (string, external), `external.traceparent` (string, OpenTelemetry), `profile` (string).

### Step
Each step is an *intent* to use a component in a mode with a minimal configuration.
- `id` (string) — stable identifier; must be unique, kebab‑case; used in `needs` and fan‑in/out expansion.
- `component` (string) — component name from Registry, e.g. `mysql.extractor`.
- `mode` (enum) — `read | write | transform`.
- `config` (object) — component configuration **without secrets**. Secrets are always referenced indirectly (see below).
- `inputs` (array&lt;string&gt;, optional) — logical inputs (namespaced by author; opaque to compiler).
- `outputs` (array&lt;string&gt;, optional) — logical outputs (namespaced by author).
- `needs` (array&lt;string&gt;, optional) — IDs of steps that must finish before this step.
- **Flow control (minimal):**
  - `when` (string, optional) — boolean expression over known metadata (e.g. prior step metrics/labels). Expression language is intentionally minimal and implementation‑defined; non‑resolvable expressions cause a compile error.
  - `branch` (object, optional) — `{ when, then: [Step], else: [Step] }`. Nested branches allowed; compiler expands into a deterministic DAG.
  - `fan_out` (object, optional) — `{ over, as, step, fan_in? }`
    - `over` (string) — expression producing a list (e.g. `${params.regions}`).
    - `as` (string) — loop variable name.
    - `step` (Step) — template step where `${var}` can be used.
    - `fan_in` (object, optional) — `{ type: "none" | "all_of" | "any_of" | "reduce", reduce_op? }`.
- **Reliability (intent):**
  - `retry` — `{ max: int, backoff: "none"|"linear"|"exp", delay_ms: int }` (compiler passes to manifest; runner enforces).
  - `timeout` (duration string).
  - `idempotency_key` (string).
- **Operational metadata (optional):**
  - `labels`/`tags` (map or array), `resources` (cpu/mem/io hints), `privacy` (`"standard"|"strict"`), `approval_required` (bool), `annotations` (freeform map).
- **Artifacts & metrics (optional):**
  - `artifacts` — what the step is expected to publish (logical names).
  - `metrics` — counters/measurements the user wants.

### Parameters & templating
- `params` entries are `{ type: "string|int|number|bool|list|map", default?, enum?[] }`.
- Binding uses `${params.foo}` anywhere a scalar is expected.
- **Precedence** at compile time: CLI `--param` &gt; ENV `OSIRIS_PARAM_*` &gt; `profiles.&lt;name&gt;.params` &gt; `params.default`.
- All `${params.*}` **must** resolve by the end of compilation, otherwise compilation **fails**.

### Profiles
- `profiles.&lt;name&gt;` can override **non‑secret** values under `params` and step `config` (safe fields only).
- Active profile chosen via `run.profile` or CLI `--profile`. The compiler emits `effective_config.json` capturing the frozen set.

### Secret handling
- OML never inlines secrets. Connections and credentials are referenced symbolically (e.g. `connection: "@mysql_default"` or `conn: "@default"`).
- The Registry defines which fields are “secret”; the compiler/validator rejects OML that inlines secrets into such fields.

### Extensibility guardrails
- Reserved top‑level keys: `oml_version`, `name`, `description`, `params`, `profiles`, `steps`, `run`.
- Custom extensions must live under `x-*` at any level (e.g. `x-owner`, `x-notes`).
- Expressions (`when`, `fan_out.over`) are deliberately bounded; no Turing‑complete templating.

### Compatibility & versioning
- Minor versions may add optional fields; removals or behavior changes require a new major/minor and an upgrade path.
- The compiler records the used `oml_version` and rejects unknown majors.

## Consequences
- Authors get a clean, minimal format to express intent that maps well to deterministic compilation.
- Security is enforceable (no secrets inline).
- We keep doors open for branching/fan‑out, parameters, profiles, and future planner hints.
- Some advanced features (rich expressions, dynamic discovery) remain out of scope; they belong in later OML versions or in the runner.

## References
- ADR‑0005/0007/0008 — Component schema & Registry
- ADR‑0013 — Chat retry policy (validation phase)
- ADR‑0015 — Compile contract (determinism, fingerprints, no‑secrets)
- Roadmap: `docs/roadmap/0.x-m1c-ideas.md`
