# Osiris Configuration – Extension Proposal

## Overview

This document specifies the proposed extensions to the Osiris pipeline configuration system. The goal is to enhance the flexibility, robustness, and traceability of configuration management through explicit support for logging, discovery cache, validation modes, precedence rules, and backward compatibility. Additionally, it defines expectations for generated YAML files, including their storage as session artifacts, and outlines tasks and a test plan for implementation.

## Configuration Extensions

### 1. Logging Configuration

The logging subsystem should be configurable via the Osiris configuration YAML with the following parameters:

- **logs_dir**: Directory path where logs are stored.
- **level**: Log verbosity level (e.g., DEBUG, INFO, WARN, ERROR).
- **events**: List of event types to log.
- **metrics**: Metrics collection configuration.
- **retention**: Duration or policy for log retention.
- **env_overrides**: Environment variables that can override logging parameters.
- **cli_flags**: Command-line interface flags to override logging settings at runtime.

Example snippet:

```yaml
logging:
  logs_dir: ./logs
  level: INFO
  events:
    - pipeline_start
    - pipeline_end
    - error
  metrics:
    enabled: true
    endpoint: http://metrics-server.local
  retention: 30d
  env_overrides:
    LOG_LEVEL: level
  cli_flags:
    --log-level: level
```

### 2. Discovery Cache Configuration

To improve performance, a discovery cache mechanism is introduced with these parameters:

- **ttl_seconds**: Time-to-live for cache entries in seconds.
- **dir**: Directory path where cache files are stored.

Example snippet:

```yaml
discovery:
  cache:
    ttl_seconds: 3600
    dir: ./cache/discovery
```

### 3. Validation Configuration

Validation modes and options are configurable to ensure pipeline correctness:

- **mode**: Validation mode, e.g., `strict`, `warn`, or `off`.
- **json**: Boolean flag to enable JSON output format for validation reports.

Example snippet:

```yaml
validate:
  mode: strict
  json: true
```

### 4. Precedence Rules

Configuration values should be resolved according to the following precedence order, from highest to lowest priority:

1. CLI flags
2. Environment variable overrides
3. Configuration YAML file
4. Default values hardcoded in the pipeline

This ensures flexible and predictable configuration behavior.

### 5. Osiris Init Template

An `osiris init` command should generate a default configuration template file reflecting the above extensions, serving as a starting point for users.

## Validation Expectations

- All YAML configuration files generated by the pipeline must be saved under the `./testing_env/output` directory.
- Additionally, these YAML files must be stored as session artifacts to ensure traceability and reproducibility.
- Validation processes should confirm the presence, correctness, and conformity of these YAML files with the expected schema and content.

## Backward Compatibility

- Existing configurations without the new extensions must continue to work without modification.
- New configuration parameters should have sensible defaults to avoid breaking existing pipelines.
- Documentation should clearly indicate which parameters are optional and their default values.

## Implementation Tasks

- Extend the configuration schema to include logging, discovery cache, and validation sections.
- Implement environment variable and CLI flag overrides respecting the precedence rules.
- Update the `osiris init` command to generate the new configuration template.
- Modify the pipeline to save generated YAML files both to `./testing_env/output` and session artifacts.
- Implement validation logic respecting the `validate` configuration section.
- Ensure backward compatibility with existing configurations.
- Update documentation to reflect all changes.
- Schema & validation: extend YAML schema, enforce enums (logging.level, validate.mode), numeric ranges, etc.
- Config loader: implement precedence logic (CLI > ENV > YAML > default), expose via `osiris.core.config.get_effective_config()`.
- Logger wiring: respect `logging.logs_dir`, fallback to temp dir on permission error, log `session_log_error`.
- Discovery cache: use `ttl_seconds` and `dir` from config, fallback defaults.
- Osiris init: update template with new config sections.
- osiris validate output: show effective values and source (CLI/ENV/YAML).
- Tests: unit tests for schema, precedence, integration for logs_dir and TTL, and security test for no secret leaks.

## Test Plan

- Verify that the pipeline generates YAML configuration files under `./testing_env/output`.
- Confirm that generated YAML files are also stored as session artifacts.
- Test logging configuration overrides via environment variables and CLI flags.
- Validate discovery cache behavior, including TTL expiration and cache directory usage.
- Test validation modes (`strict`, `warn`, `off`) and JSON output format.
- Confirm precedence rules by overriding parameters at different levels.
- Run backward compatibility tests with legacy configurations.
- Validate the correctness and completeness of the `osiris init` generated template.

By implementing these extensions and validations, the Osiris pipeline configuration system will achieve improved flexibility, traceability, and robustness, facilitating easier maintenance and auditing.

## Logging Configuration — Verification Checklist (osiris.yaml)

This checklist verifies that logging-related configuration defined in osiris.yaml (and its ENV/CLI overrides) works end-to-end. Perform the cases in order and record results in the milestone report.

### A) logs_dir precedence and write location
1. Default behavior (no YAML/ENV/CLI overrides)
   - Run:
        python ../osiris.py validate --mode warn
   - Expected:
     - A new session directory is created under ./logs/<session_id>/ with osiris.log and events.jsonl.
     - `osiris logs list` shows the new session and `osiris logs show --session <id>` prints details.

2. YAML override
   - In osiris.yaml set:
     - logging.logs_dir: ./my_logs
   - Run:
        python ../osiris.py validate --mode warn
   - Expected:
     - Session files appear under ./my_logs/<session_id>/.

3. ENV override (overrides YAML)
   - Export:
        export OSIRIS_LOGS_DIR=./env_logs
   - Run:
        python ../osiris.py validate --mode warn
   - Expected:
     - Session files appear under ./env_logs/<session_id>/.

4. CLI override (highest precedence)
   - Run:
        python ../osiris.py validate --mode warn --logs-dir ./cli_logs
   - Expected:
     - Session files appear under ./cli_logs/<session_id>/.

5. Permission fallback
   - Point logs_dir to a non-writable/non-existent parent (e.g., /root/blocked or /nonexistent/blocked):
        python ../osiris.py validate --logs-dir /nonexistent/blocked
   - Expected:
     - No traceback; logs indicate fallback to a temp directory.
     - An event like session_log_error (or equivalent) is present in the global or session log with a reason=permission_denied.

### B) level precedence and effective verbosity
1. YAML level
   - In osiris.yaml set:
     - logging.level: INFO
   - Run a short action (validate or a small discovery) and observe logs: INFO messages are present; DEBUG messages are suppressed.

2. ENV level (overrides YAML)
   - Export:
        export OSIRIS_LOG_LEVEL=DEBUG
   - Run a short action and observe logs: DEBUG messages (e.g., event=cache_lookup) are present.

3. CLI level (highest precedence)
   - Run:
        python ../osiris.py validate --log-level ERROR
   - Expected: Only ERROR (and above) messages appear.

4. Effective config reporting
   - Run:
        python ../osiris.py validate --json
   - Expected:
     - Output includes effective logging.level and logs_dir values **with their source** (cli/env/yaml/default).

### C) events/metrics toggles
1. YAML toggles
   - In osiris.yaml set:
     - logging.write_events: true
     - logging.write_metrics: true
   - Run a short action.
   - Expected: events.jsonl and metrics.jsonl exist in the session directory and contain entries.

2. Toggle off
   - Set write_events: false and/or write_metrics: false
   - Run a short action.
   - Expected: the corresponding file is not created or remains empty.

### D) retention policy (YAML-driven)
1. Configure retention
   - In osiris.yaml set:
     - logging.retention.days: 0
     - logging.retention.max_gb: 0.001
   - Create several small sessions (run validate multiple times).

2. Dry-run garbage collection
   - Run:
        osiris logs gc --dry-run
   - Expected: Proposed deletions match policy from YAML.

3. Enforce garbage collection
   - Run:
        osiris logs gc
   - Expected: Old session directories are removed according to policy.

4. Optional: gc_on_start
   - In osiris.yaml set logging.retention.gc_on_start: true
   - Run any command; verify gc is invoked at startup (check logs for gc activity).

### E) secrets redaction in logging
1. Prepare fake secrets in ENV or config (e.g., PASSWORD=SuperSecret123, API_KEY=sk-test-XYZ)
2. Run a short action that touches configuration/discovery.
3. Verify no plaintext appears in any session file:
       grep -R -i -E "SuperSecret123|sk-test-XYZ|password|api_key|token|secret|authorization" ./logs/<session_id>/
   - Expected: If keys appear, their values are masked as *** (no plaintext secrets anywhere).

### F) dual artifact storage for generated YAML
1. Trigger YAML generation (via chat or appropriate command) so that pipeline YAML is produced.
2. Expected:
   - The YAML exists in ./testing_env/output (legacy location) and is also copied under ./logs/<session_id>/artifacts/ (session artifacts).
   - All secret values inside the stored YAML are masked.

### G) discovery cache controls connected to config
1. In osiris.yaml set discovery.cache.ttl_seconds to a small number (e.g., 2).
2. Run two successive discoveries separated by a 3-second pause.
3. Expected:
   - First lookup: cache_store → then hit
   - After pause: cache_miss with reason=ttl_expired → cache_store
   - Events visible in events.jsonl for the corresponding session.

Record pass/fail for each step. Any deviation becomes an actionable task (bug or missing feature) for completion of M0-Validation-4.

## Additional Manual Test Checklist

This checklist provides detailed steps to validate the new wildcard `*` event logging functionality, effective configuration reporting, and backward compatibility.

### 1. Wildcard `events: "*"` Logging Behavior

- Modify `osiris.yaml` to set:
  ```yaml
  logging:
    events: "*"
  ```
- Run any pipeline command that triggers logging (e.g., `python ../osiris.py validate --mode warn`).
- Verify that **all events**, including those not explicitly listed before, are logged automatically.
- Introduce a new event type in the pipeline code (if possible) and confirm it appears in the logs without additional config changes.
- Confirm that the `events.jsonl` file contains entries for a wide range of event types, demonstrating automatic inclusion.

### 2. Explicit Event Lists Continue to Work

- Change `osiris.yaml` to specify an explicit list of events, for example:
  ```yaml
  logging:
    events:
      - pipeline_start
      - pipeline_end
      - error
  ```
- Run the pipeline and verify that only the specified events are logged.
- Confirm that no unexpected events appear in `events.jsonl`.

### 3. Secrets Masking with Wildcard Events

- Set `logging.events: "*"` in `osiris.yaml`.
- Inject known secrets into environment variables or config (e.g., `PASSWORD=SuperSecret123`).
- Run a pipeline command that produces logs.
- Search the session logs directory for secret values or keys (e.g., using `grep`).
- Confirm that any secret values are masked as `***` and no plaintext secrets appear anywhere in the logs.

### 4. Effective Configuration Reporting Shows Wildcard Source

- Run:
  ```bash
  python ../osiris.py validate --json
  ```
- In the output JSON, locate the `logging.events` effective value.
- Confirm that the value is `"*"` and that the source/origin field correctly indicates where it was set (YAML, ENV, or CLI).
- Repeat with environment variable override (e.g., `export OSIRIS_LOG_EVENTS="*"`), and CLI override (e.g., `--events '*'`), ensuring the source reflects the correct origin.

### 5. Backward Compatibility Check for Missing `events`

- Use an old configuration file that does **not** specify the `logging.events` parameter.
- Run the pipeline and verify that all events are logged by default (i.e., the system treats missing `events` as `"*"`).
- Confirm that logs contain a broad set of event types, similar to the wildcard behavior.
- Verify no errors or warnings occur due to the missing `events` parameter.

Record pass/fail results for each step. Any issues should be documented and reported for resolution as part of M0-Validation-4.
